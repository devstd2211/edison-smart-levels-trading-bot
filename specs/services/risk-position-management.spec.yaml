---
document: Risk & Position Management System
description: Risk management, position management, stop-loss, and dynamic position sizing

# =============================================================================
# RISK MANAGEMENT SERVICES
# =============================================================================

risk_management:
  description: Risk management system with circuit breaker, entry filters, and balance management

  # ---------------------------------------------------------------------------
  # CIRCUIT BREAKER SERVICE
  # ---------------------------------------------------------------------------
  circuit_breaker:
    service: CircuitBreakerService
    file: src/services/circuit-breaker.service.ts
    description: Protection from cascading API errors with automatic recovery

    functionality:
      error_tracking:
        description: Tracking of consecutive API errors
        counter: consecutiveApiErrors (0-5)
        threshold: MAX_CIRCUIT_BREAKER_ERRORS (default 5)
        reset_on_success: "Counter resets on successful API call"

      circuit_breaker_activation:
        trigger: "consecutiveApiErrors >= 5"
        action: Stops trading for CIRCUIT_BREAKER_RESET_MS (5 minutes)
        persistent: "State saved to file (survives restarts)"
        log: "üö® Circuit breaker tripped! Pausing trading"

      automatic_recovery:
        mechanism: Automatic reset after pause
        check: "Each cycle checks if pause time has elapsed"
        recovery: "üü¢ Circuit breaker reset, resuming trading"

      state_persistence:
        methods:
          - loadState(): Loads state from persistent storage
          - saveState(): Saves state after changes
        storage: ConfigurationService.loadCircuitBreakerState()

    methods:
      checkCircuitBreaker():
        returns: "{ canProceed: boolean, reason?: string, timeUntilReset?: number }"
        logic: |
          if tripped && now < resetTime:
            return { canProceed: false, timeUntilReset }
          else if tripped && now >= resetTime:
            resetCircuitBreaker()
            return { canProceed: true }
          else:
            return { canProceed: true }

      handleError(error):
        logic: |
          if error.type === API_ERROR:
            consecutiveApiErrors++
            if consecutiveApiErrors >= 5:
              tripCircuitBreaker()
          else:
            consecutiveApiErrors = 0  # Non-API errors reset counter

      handleSuccess():
        description: "–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"
        logic: "consecutiveApiErrors = 0"

    configuration:
      MAX_CIRCUIT_BREAKER_ERRORS: 5
      CIRCUIT_BREAKER_RESET_MS: 300000  # 5 –º–∏–Ω—É—Ç

    use_cases:
      api_outage:
        scenario: "–ë–∏—Ä–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ 5 –º–∏–Ω—É—Ç"
        behavior: "–ü–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ 5 –º–∏–Ω—É—Ç, –∑–∞—Ç–µ–º –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç"

      rate_limiting:
        scenario: "429 Too Many Requests"
        behavior: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ API_ERROR, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç circuit breaker"

  # ---------------------------------------------------------------------------
  # RISK FILTER SERVICE
  # ---------------------------------------------------------------------------
  risk_filter:
    service: RiskFilterService
    file: src/services/risk-filter.service.ts
    description: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ multi-TF RSI, –±–∞–ª–∞–Ω—Å—É –∏ —Ç—Ä–µ–Ω–¥—É

    filters:
      multi_tf_rsi_filter:
        description: –ü—Ä–æ–≤–µ—Ä–∫–∞ RSI –Ω–∞ –≤—Å–µ—Ö trend —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞—Ö (30m, 1h, 4h)

        long_filter:
          threshold: RSI_ENTRY_FILTER_OVERBOUGHT (default 70)
          condition: "majority of trend TFs > 70 ‚Üí BLOCK or ADVISORY"
          modes:
            blocking_mode:
              enabled: RSI_ADVISORY_MODE=false
              action: "canProceed: false"
              log: "üö´ LONG blocked - majority of trend timeframes overbought"

            advisory_mode:
              enabled: RSI_ADVISORY_MODE=true
              action: "canProceed: true + confidencePenalty: 0.2"
              log: "‚ö†Ô∏è LONG advisory - majority overbought, reducing confidence"

        short_filter:
          threshold: RSI_ENTRY_FILTER_OVERSOLD (default 35)
          condition: "majority of trend TFs < 35 ‚Üí BLOCK or ADVISORY"
          logic: "–°–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ LONG"

        example:
          scenario: "RSI = [Main: 55, Trend1(30m): 72, Trend2(1h): 75, Context(4h): 68]"
          analysis: "3 –∏–∑ 4 —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ > 70 (majority)"
          blocking_result: "LONG blocked"
          advisory_result: "LONG allowed with -0.2 confidence penalty"

      balance_check:
        method: checkBalanceForLong(usdtBalance)
        condition: "usdtBalance < basePositionSize ‚Üí BLOCK"
        returns: "{ canProceed: false, reason: 'Insufficient balance' }"

      trend_block_filter:
        description: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø—Ä–æ—Ç–∏–≤ —Ç—Ä–µ–Ω–¥–∞ –ë–ï–ó —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π"

        long_in_bear_trend:
          condition: "trend === BEAR || STRONG_BEAR"
          allowed_if: "RSI Main < 30 OR RSI Trend1 < 30 (extreme oversold)"
          blocked_if: "NOT (oversold conditions)"
          reason: "Bear trend without oversold (RSI Main 55, Trend1 45)"
          log: "üö´ LONG blocked - bear trend without oversold conditions"

        short_in_bull_trend:
          condition: "trend === BULL || STRONG_BULL"
          allowed_if: "RSI Main > 85 OR RSI Trend1 > 85 (extreme overbought)"
          blocked_if: "NOT (overbought conditions)"
          reason: "Bull trend without overbought"

        oversold_bounce_example:
          scenario: "BEAR trend, RSI Trend1 = 28 (oversold)"
          result: "‚úÖ LONG allowed - Longing bounce on oversold higher timeframe"

    configuration:
      RSI_ADVISORY_MODE: true/false  # Advisory vs Blocking mode
      RSI_CONFIDENCE_PENALTY: 0.2    # Penalty in advisory mode
      RSI_ENTRY_FILTER_OVERBOUGHT: 70
      RSI_ENTRY_FILTER_OVERSOLD: 35
      EXTREME_RSI_THRESHOLD: 30  # For trend block exceptions

    integration:
      called_by: SignalGeneratorService.generateSignals()
      flow: |
        1. Check multi-TF RSI filter
        2. Check balance
        3. Check trend block
        4. Return filter result

  # ---------------------------------------------------------------------------
  # BALANCE MANAGER SERVICE
  # ---------------------------------------------------------------------------
  balance_manager:
    service: BalanceManagerService
    file: src/services/balance-manager.service.ts
    description: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ drift detection

    features:
      initial_balance_tracking:
        description: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ò–ó–ù–ê–ß–ê–õ–¨–ù–´–ô –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ"
        reason: "–ò–°–ü–†–ê–í–õ–Ø–ï–¢ –ø—Ä–æ–±–ª–µ–º—É —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏"
        variable: initialBalance (from config)
        formula: "positionSize = initialBalance √ó POSITION_SIZE_PERCENT"

      reserved_amount_tracking:
        description: "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è pending orders"
        variables:
          - reservedAmount: float (—Å—É–º–º–∞ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
          - ordersPlaced: int (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ä–¥–µ—Ä–æ–≤)

      drift_detection:
        description: "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ –∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞"
        check: "if calculated > actualAvailable ‚Üí DRIFT DETECTED"
        action: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤–º–µ—Å—Ç–æ —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ"
        log: "üö® BALANCE DRIFT DETECTED! calculated: $50, actual: $45, drift: $5"

    methods:
      calculatePositionSize(positionSizePercent, signalConfidence):
        description: "–£–º–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏"
        steps:
          step1_base_calculation:
            formula: "basePositionValue = initialBalance √ó positionSizePercent / 100"
            example: "$1000 √ó 1.0% = $10"

          step2_confidence_adjustment:
            formula: "adjustedValue = basePositionValue √ó signalConfidence"
            example: "$10 √ó 0.85 = $8.50"

          step3_limit_checks:
            checks:
              - "ordersPlaced >= MAX_PENDING_ORDERS ‚Üí BLOCK"
              - "adjustedValue < MIN_ORDER_VALUE ‚Üí BLOCK"
              - "adjustedValue > MAX_ORDER_VALUE ‚Üí CAP to MAX"

          step4_drift_detection:
            check: "reservedAmount + adjustedValue > maxTotalExposure"
            action: "Calculate maxAvailable, check drift"
            drift_correction: "Use actualAvailable instead of calculated"

        returns: "{ positionValue: number, canPlace: boolean, reason?: string }"

      reserveForOrder(positionValue):
        action: |
          reservedAmount += positionValue
          ordersPlaced++
        log: "üîí Reserved $10 USDT (totalReserved: $20, ordersPlaced: 2)"

      releaseFromOrder(positionValue):
        action: |
          reservedAmount = max(0, reservedAmount - positionValue)
          ordersPlaced = max(0, ordersPlaced - 1)
        log: "üîì Released $10 USDT (totalReserved: $10, ordersPlaced: 1)"

      getBalanceState(currentBalance):
        returns: |
          {
            totalBalance: initialBalance,
            reservedForOrders: reservedAmount,
            emergencyReserve: initialBalance √ó 0.05,
            availableForNewOrders: maxExposure - reserved,
            maxTotalExposure: initialBalance √ó 0.95,
            ordersPlaced: ordersPlaced
          }

    configuration:
      BALANCE_INITIAL_AMOUNT: 1000  # –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
      BALANCE_MAX_TOTAL_EXPOSURE: 0.95  # 95% –±–∞–ª–∞–Ω—Å–∞ –¥–æ—Å—Ç—É–ø–Ω–æ
      BALANCE_EMERGENCY_RESERVE: 0.05   # 5% —Ä–µ–∑–µ—Ä–≤
      BALANCE_MIN_ORDER_VALUE: 5        # –ú–∏–Ω–∏–º—É–º $5
      BALANCE_MAX_ORDER_VALUE: 50       # –ú–∞–∫—Å–∏–º—É–º $50
      BALANCE_MAX_PENDING_ORDERS: 5     # –î–æ 5 –æ—Ä–¥–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
      BALANCE_MAX_DAILY_ORDERS: 100     # –î–æ 100 –æ—Ä–¥–µ—Ä–æ–≤ –≤ –¥–µ–Ω—å

    decimal_precision:
      library: Decimal.js
      reason: "–ò–∑–±–µ–≥–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è floating-point –æ—à–∏–±–æ–∫"
      usage: "–í—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á—ë—Ç—ã —á–µ—Ä–µ–∑ new Decimal()"

# =============================================================================
# POSITION MANAGEMENT SERVICES
# =============================================================================

position_management:
  description: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—å—é—á–µ—Ä—Å–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ —Å TP/SL, trailing stop –∏ dynamic sizing

  # ---------------------------------------------------------------------------
  # FUTURES POSITION MANAGER
  # ---------------------------------------------------------------------------
  futures_position_manager:
    service: FuturesPositionManagerService
    file: src/services/futures-position-manager.service.ts
    description: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è–º–∏ –æ—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

    architecture:
      local_cache:
        description: "Map<positionId, Position>"
        purpose: "–•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (TP levels, reasons, timestamps)"
        source_of_truth: "API –±–∏—Ä–∂–∏ (positions, quantity, PnL)"
        synchronization: "monitorPositions() —É–¥–∞–ª—è–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏"

      pending_orders:
        description: "Map<orderId, PendingOrder>"
        purpose: "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –¥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è"
        lifecycle: |
          1. openPosition() ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ pending
          2. WebSocket order.filled ‚Üí createPositionFromFilledOrder()
          3. –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ pending

    position_lifecycle:
      step1_open_position:
        method: "openPosition(params)"
        description: "–†–∞–∑–º–µ—â–∞–µ—Ç entry –æ—Ä–¥–µ—Ä (Market –∏–ª–∏ Limit)"

        order_types:
          market_order:
            enabled: FUTURES_USE_MARKET_ORDERS=true
            price: currentPrice
            execution: "–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ"

          limit_order:
            enabled: FUTURES_USE_MARKET_ORDERS=false
            offset: FUTURES_BUY_LIMIT_OFFSET (default 0.01%)
            price_long: "currentPrice √ó (1 - 0.01%)"
            price_short: "currentPrice √ó (1 + 0.01%)"
            execution: "–ñ–¥—ë—Ç WebSocket fill event"

        dynamic_sizing:
          enabled: "if dynamicSizer exists"
          calculation: "quantity = (dynamicSize √ó leverage) / currentPrice"
          log: "üí∞ Dynamic Position Sizing applied: 10.0 ‚Üí 12.5 USDT"

        race_condition_fix:
          problem: "WebSocket –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Ä–∞–Ω—å—à–µ API response"
          solution: "–°–æ–∑–¥–∞—ë–º pending –î–û API –≤—ã–∑–æ–≤–∞ —Å temp ID"
          temp_id: "temp_{symbol}_{side}_{timestamp}_{random}"
          flow: |
            1. Create pending with tempOrderId
            2. Add to pendingOrders map
            3. Call API
            4. Update pending with real orderId

        risk_checks:
          - checkPositionLimits(side): –ü—Ä–æ–≤–µ—Ä–∫–∞ MAX_OPEN_POSITIONS
          - checkMarginAvailable(quantity, leverage): –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞

      step2_create_position:
        method: "createPositionFromFilledOrder(pending)"
        trigger: "WebSocket order filled event"

        position_creation:
          fetch_position: "–ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å –±–∏—Ä–∂–∏ —á–µ—Ä–µ–∑ API"
          local_position: |
            {
              id: "{symbol}_{side}_{timestamp}",
              ...bybitPosition,
              reason: pending.reason
            }

        stop_loss_setup:
          standard_sl:
            calculation: "SL = entryPrice √ó (1 ¬± stopLossPercent)"
            example_long: "Entry $2.30, SL 0.4% ‚Üí $2.2908"

          level_based_sl:
            enabled: "LEVEL_STOP_BEHIND_LEVEL=true && strategy=Level-Based"
            calculation: "SL = levelPrice √ó (1 ¬± offsetPercent)"
            offset: LEVEL_STOP_OFFSET_PERCENT (default 0.5%)
            logic_long: "–°—Ç–æ–ø –ù–ò–ñ–ï support —É—Ä–æ–≤–Ω—è"
            logic_short: "–°—Ç–æ–ø –í–´–®–ï resistance —É—Ä–æ–≤–Ω—è"
            example: "Support $2.30, offset 0.5% ‚Üí SL $2.2885"

        take_profit_setup:
          levels:
            - TP1: "0.6% (50% –ø–æ–∑–∏—Ü–∏–∏)"
            - TP2: "1.0% (30% –ø–æ–∑–∏—Ü–∏–∏)"
            - TP3: "1.8% (20% –ø–æ–∑–∏—Ü–∏–∏)"

          placement: "–†–∞–∑–º–µ—â–∞–µ—Ç –≤—Å–µ TP –æ—Ä–¥–µ—Ä–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"
          tracking: "–°–æ—Ö—Ä–∞–Ω—è–µ—Ç orderId –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è"

        trade_journal:
          enabled: "if tradeJournal exists"
          records: |
            {
              positionId, symbol, entryConditions,
              entryPrice, quantity, leverage,
              stopLoss, takeProfitLevels,
              openedAt, status: 'open'
            }

        telegram_notification:
          event: notifyPositionEntry(position)
          includes: "Entry price, leverage, SL, TP levels"

      step3_monitor_position:
        method: "monitorPositions()"
        frequency: FUTURES_POSITION_CHECK_INTERVAL_MS (default 60000ms)

        synchronization:
          fetch: "–ü–æ–ª—É—á–∞–µ–º –í–°–ï –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–∏"
          filter: "–¢–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã–µ (quantity > 0)"
          cleanup: "–£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä—ã—Ç—ã–µ –∏–∑ local cache"

        tp_level_detection:
          method: checkTakeProfitLevels(position)
          check: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ TP –æ—Ä–¥–µ—Ä–∞"
          on_filled: "–í—ã–∑—ã–≤–∞–µ—Ç onTakeProfitHit(position, level)"

        closed_position_detection:
          trigger: "–ü–æ–∑–∏—Ü–∏—è –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ—Ç –Ω–∞ –±–∏—Ä–∂–µ"
          analysis: |
            - Check if trailing was active ‚Üí "Trailing Stop triggered"
            - Check if SL moved to breakeven ‚Üí "Breakeven SL triggered"
            - Else ‚Üí "Position closed (unknown reason)"

          journal_fallback: "–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –∂—É—Ä–Ω–∞–ª –µ—Å–ª–∏ WebSocket –ø—Ä–æ–ø—É—Å—Ç–∏–ª"
          no_telegram: "Telegram —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ WebSocket handlers"

      step4_tp_hit_logic:
        method: "onTakeProfitHit(position, level)"

        tp1_hit:
          action: "–ü–µ—Ä–µ–º–µ—â–∞–µ—Ç SL –≤ breakeven (entry + 0.2%)"
          offset: FUTURES_BREAKEVEN_OFFSET_PERCENT (default 0.12%)
          calculation_long: "breakeven = entryPrice √ó (1 + 0.12%)"
          calculation_short: "breakeven = entryPrice √ó (1 - 0.12%)"
          log: "‚úÖ Stop moved to breakeven + offset"
          telegram: notifyBreakevenStop(position, breakevenPrice)

        tp2_hit:
          action: "Trailing stop –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ StopLossManager"
          trigger: "shouldActivateTrailing() –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ activationPercent"

        all_tps_filled:
          detection: "position.takeProfitLevels.every(tp => tp.filled)"
          action: "–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª–Ω–æ—Å—Ç—å—é"
          reason: "All TP levels filled"

      step5_close_position:
        method: "closePosition(positionId, reason)"

        cleanup_orders:
          tp_orders: "–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ TP –æ—Ä–¥–µ—Ä–∞"
          sl_order: "–û—Ç–º–µ–Ω—è–µ—Ç Stop Loss –æ—Ä–¥–µ—Ä"

        close_execution:
          api_call: "bybit.closeFuturesPosition(symbol, side)"
          market_order: "–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ"

        metrics_calculation:
          realized_pnl: position.unrealizedPnL
          realized_pnl_percent: "(realizedPnL / margin) √ó 100"
          holding_time_ms: "closedAt - openedAt"
          tp_levels_hit: "TP —É—Ä–æ–≤–Ω–∏ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏"
          stopped_out: "–ó–∞–∫—Ä—ã—Ç–æ –ø–æ —Å—Ç–æ–ø—É (true/false)"

        journal_recording:
          exit_conditions: |
            {
              closeReason, closePrice, closedAt,
              realizedPnL, realizedPnLPercent,
              holdingTimeMs, tpLevelsHit,
              stoppedOut, trailingStopUsed
            }

        dynamic_sizing_update:
          enabled: "if dynamicSizer exists"
          call: "dynamicSizer.updateAfterTrade(realizedPnL)"

        telegram_notification:
          event: notifyPositionExit(position, reason, closePrice, pnl, pnlPercent, tpLevels)

    websocket_handlers:
      handle_position_update:
        topic: "position.linear"
        trigger: "–ü–æ–∑–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∞"

        position_closed_detection:
          condition: "size === 0"
          analysis: |
            Priority 1: Check if trailing was active
            Priority 2: Check if breakeven SL (after TP hit)
            Priority 3: Check if initial SL (no TPs hit)
            Priority 4: Unknown (manual close / liquidation)

          close_reasons:
            - "Trailing Stop triggered (server-side)"
            - "Breakeven Stop Loss triggered"
            - "Stop Loss triggered"
            - "Position closed on exchange (unknown reason)"

          order_cleanup:
            tp_orders: "–û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ TP"
            sl_order: "–û—Ç–º–µ–Ω—è–µ—Ç SL (–º–æ–∂–µ—Ç –±—ã—Ç—å already executed)"

          journal_recording: "–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç exit conditions"
          telegram: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ø–æ —Ç–∏–ø—É –∑–∞–∫—Ä—ã—Ç–∏—è)"
          cache_removal: "positions.delete(position.id)"

        position_updated:
          updates: "quantity, unrealizedPnL, liquidationPrice, updatedAt"

      handle_order_update:
        topic: "order.linear"
        trigger: "–û—Ä–¥–µ—Ä –∏–∑–º–µ–Ω–∏–ª —Å—Ç–∞—Ç—É—Å (Filled/Cancelled/Rejected)"

        priority1_pending_orders:
          check: "–ò—â–µ—Ç orderId –≤ pendingOrders map"
          race_condition_fix: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç temp IDs –µ—Å–ª–∏ real ID –Ω–µ –Ω–∞–π–¥–µ–Ω"

          filled:
            action: "createPositionFromFilledOrder(pending)"
            cleanup: "pendingOrders.delete(orderId)"

          cancelled_rejected:
            log: "‚ö†Ô∏è Pending order cancelled/rejected"
            cleanup: "pendingOrders.delete(orderId)"

        priority2_tp_orders:
          check: "–ò—â–µ—Ç orderId –≤ position.takeProfitLevels"

          tp_filled:
            action: "tpLevel.filled = true"
            check_all_filled: "if all TPs filled ‚Üí close position"
            partial_close: "onTakeProfitHit(position, level)"
            telegram: notifyTakeProfitHit(position, tpLevel)

          all_tps_filled:
            sl_cleanup: "–û—Ç–º–µ–Ω—è–µ—Ç –≤–∏—Å—è—â–∏–π Stop Loss"
            journal: "–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç exit —Å tpLevelsHit"
            telegram: notifyAllTakeProfitsHit()
            cache_removal: "positions.delete()"

        priority3_trailing_stop:
          detection: "stopOrderType === TrailingStop && status === Filled"
          description: "Server-side Bybit trailing stop —Å—Ä–∞–±–æ—Ç–∞–ª"

          journal_recording:
            close_reason: "Trailing Stop triggered (server-side)"
            stopped_out: true
            trailing_stop_used: true

          telegram: notifyTrailingStopTriggered()
          cache_removal: "positions.delete() –°–†–ê–ó–£"

        priority4_sl_orders:
          check: "position.stopLoss.orderId === orderId"

          breakeven_sl:
            detection: "TP hit + SL moved to entry"
            close_reason: "Breakeven Stop Loss triggered"
            telegram: notifyBreakevenStopTriggered()

          initial_sl:
            detection: "No TPs hit + negative PnL"
            close_reason: "Stop Loss triggered"
            telegram: notifyStopLossTriggered()

          journal_recording: "–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç exit conditions"
          cache_removal: "positions.delete() –°–†–ê–ó–£"

      handle_execution_update:
        topic: "execution.linear"
        purpose: "–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)"
        note: "–û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ orderUpdate"

    position_limits:
      max_open_positions: FUTURES_MAX_OPEN_POSITIONS (default 1)
      max_long_positions: FUTURES_MAX_LONG_POSITIONS (default 2)
      max_short_positions: FUTURES_MAX_SHORT_POSITIONS (default 2)

      symbol_check:
        critical: "–û–î–ù–ê –ø–æ–∑–∏—Ü–∏—è –Ω–∞ symbol (–Ω–µ—Ç hedging)"
        check: "existingPosition.symbol === symbol ‚Üí BLOCK"

    pending_orders_timeout:
      method: checkPendingOrdersTimeout()
      frequency: "–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –∏–∑ trading cycle"
      timeout: FUTURES_PENDING_ORDER_TIMEOUT_MS (default 120000ms)
      action: "–û—Ç–º–µ–Ω—è–µ—Ç –æ—Ä–¥–µ—Ä–∞ —Å—Ç–∞—Ä—à–µ 2 –º–∏–Ω—É—Ç"

  # ---------------------------------------------------------------------------
  # STOP LOSS MANAGER
  # ---------------------------------------------------------------------------
  stop_loss_manager:
    service: StopLossManagerService
    file: src/services/stop-loss-manager.service.ts
    description: ATR-based adaptive trailing stop —Å minimum profit floor

    features:
      initial_stop_loss:
        method: "setInitialStopLoss(position, stopLossPrice)"
        description: "–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π SL (–¥–ª—è Level-Based)"
        placement: "–†–∞–∑–º–µ—â–∞–µ—Ç fixed Stop Loss –æ—Ä–¥–µ—Ä –Ω–∞ –±–∏—Ä–∂–µ"

      adaptive_activation:
        description: "üî• –ê–î–ê–ü–¢–ò–í–ù–´–ô threshold = ATR distance"
        reason: "–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ trailing —Å—Ä–∞–∑—É –≤ breakeven"

        calculation:
          atr: "priceAnalyzer.calculateATR(14 periods)"
          atr_based_distance: "ATR √ó 1.5 (–∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏)"
          min_max_clamp: "1.0% - 4.0%"

          activation_threshold: "MIN(config, atrBasedDistance)"
          logic: "–ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–∏–π (—Ä–∞–Ω—å—à–µ –∞–∫—Ç–∏–≤–∞—Ü–∏—è)"

        no_fallback:
          rule: "–ï—Å–ª–∏ –Ω–µ—Ç PriceAnalyzer ‚Üí –ù–ï –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º trailing"
          reason: "–ù–µ–ª—å–∑—è —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π threshold –±–µ–∑ ATR"

        example:
          scenario: "ATR = 2.5%, config = 0.6%"
          activation: "0.6% (config –º–µ–Ω—å—à–µ, –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–∞–Ω—å—à–µ)"
          trailing_distance: "2.5% (ATR-based)"
          result: "–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ, –Ω–æ trailing —à–∏—Ä–æ–∫–∏–π ‚Üí breakeven –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω"

      atr_based_trailing:
        description: "Trailing distance –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"

        calculation:
          atr_periods: TRAILING_STOP_ATR_PERIODS (default 14)
          atr_multiplier: TRAILING_STOP_ATR_MULTIPLIER (default 1.5)
          trailing_distance: "ATR √ó 1.5, clamped to [1%, 4%]"

        examples:
          low_volatility:
            atr: "0.8%"
            distance: "1.2% (< 1% min) ‚Üí 1.0%"

          normal_volatility:
            atr: "1.8%"
            distance: "2.7%"

          high_volatility:
            atr: "3.5%"
            distance: "5.25% (> 4% max) ‚Üí 4.0%"

      minimum_profit_floor:
        description: "üõ°Ô∏è –¢—Ä–µ–π–ª–∏–Ω–≥ –ù–ï –ú–û–ñ–ï–¢ –±—ã—Ç—å –Ω–∏–∂–µ entry + 0.3%"
        reason: "–ó–∞—â–∏—Ç–∞ –ø—Ä–æ—Ñ–∏—Ç–∞ –ø–æ—Å–ª–µ TP1"

        floor_calculation:
          long: "floorPrice = entryPrice √ó (1 + 0.3%)"
          short: "floorPrice = entryPrice √ó (1 - 0.3%)"

        adjustment:
          condition_long: "if newStopPrice < floorPrice ‚Üí set to floor"
          condition_short: "if newStopPrice > floorPrice ‚Üí set to floor"
          log: "üõ°Ô∏è Trailing stop adjusted to minimum floor (entry + 0.3%)"

      server_side_trailing:
        description: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç native Bybit trailing stop (server-side)"
        activation: "–ü–æ—Å–ª–µ shouldActivateTrailing() ‚Üí setTrailingStop()"

        process:
          step1: "–û—Ç–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π fixed SL –æ—Ä–¥–µ—Ä"
          step2: "–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç Bybit trailing stop"
          step3: "–ê–î–ê–ü–¢–ò–í–ù–´–ô TP3: –æ—Ç–º–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç—Ä–µ–Ω–¥ —Å–∏–ª—å–Ω—ã–π"

        no_manual_updates:
          reason: "–ë–∏—Ä–∂–∞ —Å–∞–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç trailing (–¥–≤–∏–≥–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
          log: "‚úÖ Trailing Stop already active (server-side), no manual updates needed"

      adaptive_tp3_cancellation:
        description: "–£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã TP3 –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞"

        trend_strength_check:
          method: checkTrendStrength(position)
          criteria: "TP1 ‚Üí TP2 < 30 —Å–µ–∫—É–Ω–¥ = HYPER SCALPING MODE"

          strong_trend:
            time: "< 30 seconds"
            action: "–û—Ç–º–µ–Ω—è–µ—Ç TP3 ‚Üí –µ–¥–µ–º –∫ ATH —Å trailing"
            log: "üöÄ Strong trend detected - canceling TP3 to ride trailing to ATH"

          weak_trend:
            time: ">= 30 seconds"
            action: "–û—Å—Ç–∞–≤–ª—è–µ—Ç TP3 –∫–∞–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫—É (2.2%)"
            log: "üõ°Ô∏è Weak trend detected - keeping TP3 as safety net"

    monitoring:
      method: monitorAndUpdateStops(positions)
      frequency: FUTURES_TRAILING_UPDATE_INTERVAL_MS (default 30000ms)

      per_position:
        - fetch: "–ü–æ–ª—É—á–∞–µ–º currentPrice"
        - update: "updateTrailingStop(position, currentPrice)"

      race_condition_fix:
        check: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ü–ï–†–ï–î –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º"
        reason: "–ü–æ–∑–∏—Ü–∏—è –º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å—Å—è –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏"

    configuration:
      TRAILING_STOP_ATR_PERIODS: 14
      TRAILING_STOP_ATR_MULTIPLIER: 1.5
      TRAILING_STOP_MIN_DISTANCE: 1.0  # %
      TRAILING_STOP_MAX_DISTANCE: 4.0  # %
      TRAILING_STOP_MIN_PROFIT_FLOOR: 0.3  # %
      FUTURES_TRAILING_UPDATE_INTERVAL_MS: 30000

  # ---------------------------------------------------------------------------
  # DYNAMIC POSITION SIZER
  # ---------------------------------------------------------------------------
  dynamic_position_sizer:
    service: DynamicPositionSizerService
    file: src/services/dynamic-position-sizer.service.ts
    description: Compound interest sizing —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º

    concept:
      description: "–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (COMPOUND!)"
      formula: "nextPositionSize = baseSize + accumulatedProfit"
      max_cap: "maxPositionSize (–∑–∞—â–∏—Ç–∞ –æ—Ç overexposure)"

    state_management:
      persistence:
        file: "data/position-sizing-state.json"
        format: |
          {
            currentPositionSize: 12.50,
            accumulatedProfit: 2.50,
            consecutiveWins: 3,
            consecutiveLosses: 0,
            totalTrades: 15,
            lastUpdated: "2025-10-15T12:30:00Z"
          }

      methods:
        loadState(): "–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ —Ñ–∞–π–ª–∞ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç defaults"
        saveState(): "–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è"

    lifecycle:
      get_position_size:
        method: getPositionSize()
        returns: "enabled ? currentPositionSize : basePositionSize"
        used_by: "FuturesPositionManager.openPosition()"

      update_after_trade:
        method: "updateAfterTrade(realizedPnL)"
        trigger: "–ü–æ—Å–ª–µ closePosition()"

        on_win:
          condition: "realizedPnL > 0"
          calculation: |
            accumulatedProfit += realizedPnL
            currentPositionSize = baseSize + accumulatedProfit
            if currentPositionSize > maxSize:
              currentPositionSize = maxSize

          counters: |
            consecutiveWins++
            consecutiveLosses = 0

          log: "‚úÖ WIN - Position size increased (COMPOUND): $10 ‚Üí $12.50 (+25%)"

        on_loss:
          reset_mode:
            enabled: RESET_ON_LOSS=true
            action: |
              accumulatedProfit = 0
              currentPositionSize = baseSize
            log: "‚ùå LOSS - Position size reset to base: $12.50 ‚Üí $10 (lost $2.50)"

          compound_mode:
            enabled: RESET_ON_LOSS=false
            action: |
              accumulatedProfit += realizedPnL  # realizedPnL negative
              currentPositionSize = max(baseSize, baseSize + accumulatedProfit)
            log: "‚ùå LOSS - Position size reduced: $12.50 ‚Üí $11 (accumulated: $1)"

    configuration:
      DYNAMIC_SIZING_ENABLED: true/false
      DYNAMIC_BASE_POSITION_SIZE: 10  # USDT
      DYNAMIC_MAX_POSITION_SIZE: 50   # USDT
      DYNAMIC_RESET_ON_LOSS: true     # Reset vs compound losses

    examples:
      winning_streak:
        trades:
          - trade1: "Base $10 ‚Üí Win +$2 ‚Üí Next $12"
          - trade2: "$12 ‚Üí Win +$3 ‚Üí Next $15"
          - trade3: "$15 ‚Üí Win +$5 ‚Üí Next $20"
        result: "Position size —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ—Ñ–∏—Ç–æ–º (compound interest)"

      loss_with_reset:
        trades:
          - trade1: "Base $10 ‚Üí Win +$5 ‚Üí Next $15"
          - trade2: "$15 ‚Üí Loss -$3 ‚Üí Reset to $10"
        result: "–ü–æ—Ç–µ—Ä—è–Ω accumulated profit, –Ω–æ base —Å–æ—Ö—Ä–∞–Ω—ë–Ω"

      loss_without_reset:
        trades:
          - trade1: "Base $10 ‚Üí Win +$5 ‚Üí Next $15"
          - trade2: "$15 ‚Üí Loss -$3 ‚Üí Next $12 (base + $2)"
        result: "–ß–∞—Å—Ç—å –ø—Ä–æ—Ñ–∏—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"

# =============================================================================
# INTEGRATION & DATA FLOW
# =============================================================================

integration:
  trading_cycle_flow:
    step1_risk_checks:
      - CircuitBreaker.checkCircuitBreaker() ‚Üí can proceed?
      - RiskFilter.checkLongEntryFilter() ‚Üí RSI OK?
      - RiskFilter.checkBalanceForLong() ‚Üí balance OK?
      - RiskFilter.checkTrendBlockForLong() ‚Üí trend OK?

    step2_position_sizing:
      - BalanceManager.calculatePositionSize() ‚Üí size OK?
      - DynamicPositionSizer.getPositionSize() ‚Üí compound size
      - BalanceManager.reserveForOrder() ‚Üí lock funds

    step3_position_opening:
      - FuturesPositionManager.openPosition() ‚Üí place order
      - Pending order tracking
      - WebSocket monitoring

    step4_position_monitoring:
      - FuturesPositionManager.monitorPositions() ‚Üí sync with exchange
      - StopLossManager.monitorAndUpdateStops() ‚Üí trailing logic
      - WebSocket updates ‚Üí real-time events

    step5_position_closing:
      - TP hit / SL hit / manual close
      - FuturesPositionManager.closePosition() ‚Üí cleanup
      - DynamicPositionSizer.updateAfterTrade() ‚Üí update sizing
      - BalanceManager.releaseFromOrder() ‚Üí unlock funds

  error_recovery:
    circuit_breaker_trip:
      - "–ü–æ—Å–ª–µ 5 API errors ‚Üí –ø–∞—É–∑–∞ 5 –º–∏–Ω—É—Ç"
      - "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"

    websocket_disconnection:
      - "Polling fallback —á–µ—Ä–µ–∑ monitorPositions()"
      - "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥"

    race_conditions:
      - "Temp order IDs –¥–ª—è pending"
      - "Position existence check –ø–µ—Ä–µ–¥ updates"
      - "Journal fallback –µ—Å–ª–∏ WebSocket –ø—Ä–æ–ø—É—Å—Ç–∏–ª"

# =============================================================================
# CONFIGURATION SUMMARY
# =============================================================================

configuration_summary:
  circuit_breaker:
    MAX_CIRCUIT_BREAKER_ERRORS: 5
    CIRCUIT_BREAKER_RESET_MS: 300000  # 5 min

  risk_filters:
    RSI_ADVISORY_MODE: true
    RSI_CONFIDENCE_PENALTY: 0.2
    RSI_ENTRY_FILTER_OVERBOUGHT: 70
    RSI_ENTRY_FILTER_OVERSOLD: 35
    EXTREME_RSI_THRESHOLD: 30

  balance_management:
    BALANCE_INITIAL_AMOUNT: 1000
    BALANCE_MAX_TOTAL_EXPOSURE: 0.95
    BALANCE_EMERGENCY_RESERVE: 0.05
    BALANCE_MIN_ORDER_VALUE: 5
    BALANCE_MAX_ORDER_VALUE: 50
    BALANCE_MAX_PENDING_ORDERS: 5

  futures_positions:
    FUTURES_MAX_OPEN_POSITIONS: 1
    FUTURES_MAX_LONG_POSITIONS: 2
    FUTURES_MAX_SHORT_POSITIONS: 2
    FUTURES_USE_MARKET_ORDERS: true
    FUTURES_BUY_LIMIT_OFFSET: 0.01
    FUTURES_PENDING_ORDER_TIMEOUT: 120000  # 2 min
    FUTURES_POSITION_CHECK_INTERVAL: 60000  # 1 min

  take_profit:
    FUTURES_TAKE_PROFIT_1: 0.6  # %
    FUTURES_TAKE_PROFIT_2: 1.0  # %
    FUTURES_TAKE_PROFIT_3: 1.8  # %
    FUTURES_TP1_SIZE: 50  # %
    FUTURES_TP2_SIZE: 30  # %
    FUTURES_TP3_SIZE: 20  # %

  stop_loss:
    FUTURES_STOP_LOSS_PERCENT: 0.4
    FUTURES_BREAKEVEN_OFFSET_PERCENT: 0.12
    LEVEL_STOP_BEHIND_LEVEL: true
    LEVEL_STOP_OFFSET_PERCENT: 0.5

  trailing_stop:
    TRAILING_STOP_ATR_PERIODS: 14
    TRAILING_STOP_ATR_MULTIPLIER: 1.5
    TRAILING_STOP_MIN_DISTANCE: 1.0
    TRAILING_STOP_MAX_DISTANCE: 4.0
    TRAILING_STOP_MIN_PROFIT_FLOOR: 0.3
    FUTURES_TRAILING_UPDATE_INTERVAL: 30000  # 30 sec

  dynamic_sizing:
    DYNAMIC_SIZING_ENABLED: true
    DYNAMIC_BASE_POSITION_SIZE: 10
    DYNAMIC_MAX_POSITION_SIZE: 50
    DYNAMIC_RESET_ON_LOSS: true

# =============================================================================
# BEST PRACTICES
# =============================================================================

best_practices:
  risk_management:
    - "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç API outages"
    - "–í–∫–ª—é—á–∞–π—Ç–µ RSI Advisory Mode –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ –≤–º–µ—Å—Ç–æ –∂—ë—Å—Ç–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
    - "–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ balance drift –∏ –¥–æ–≤–µ—Ä—è–π—Ç–µ real-time –ø—Ä–æ–≤–µ—Ä–∫–∞–º"
    - "–ù–µ –ø—Ä–µ–≤—ã—à–∞–π—Ç–µ MAX_TOTAL_EXPOSURE (95% –±–∞–ª–∞–Ω—Å–∞)"

  position_management:
    - "–û–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ symbol (–∏–∑–±–µ–≥–∞–π—Ç–µ hedging)"
    - "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Market Orders –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è"
    - "–†–∞–∑–º–µ—â–∞–π—Ç–µ –≤—Å–µ TP —É—Ä–æ–≤–Ω–∏ —Å—Ä–∞–∑—É (–Ω–µ –∂–¥–∏—Ç–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)"
    - "–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ existence –ø–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º update"

  stop_loss_strategy:
    - "–î–ª—è Level-Based: —Å—Ç–æ–ø—ã –ó–ê —É—Ä–æ–≤–Ω—è–º–∏ (Priority 1)"
    - "–ü–æ—Å–ª–µ TP1: –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ SL –≤ breakeven (entry + 0.2%)"
    - "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ATR-based trailing –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏"
    - "Minimum profit floor = entry + 0.3% (–∑–∞—â–∏—Ç–∞ –ø—Ä–æ—Ñ–∏—Ç–∞)"
    - "–û—Ç–º–µ–Ω—è–π—Ç–µ TP3 –¢–û–õ–¨–ö–û –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ (< 30 sec TP1‚ÜíTP2)"

  dynamic_sizing:
    - "–í–∫–ª—é—á–∞–π—Ç–µ compound interest –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–æ—Å—Ç–∞"
    - "RESET_ON_LOSS=true –¥–ª—è –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞"
    - "MAX_POSITION_SIZE –∫–∞–∫ –∑–∞—â–∏—Ç–∞ –æ—Ç overexposure"
    - "–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ state –≤ —Ñ–∞–π–ª (–ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç —Ä–µ—Å—Ç–∞—Ä—Ç—ã)"

  websocket_handling:
    - "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ pending –î–û API –≤—ã–∑–æ–≤–∞ (race condition fix)"
    - "–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤ journal –î–û —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ cache"
    - "–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ order existence –ø–µ—Ä–µ–¥ cancel (avoid errors)"
    - "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ polling fallback (monitorPositions) –Ω–∞ —Å–ª—É—á–∞–π WebSocket drops"
